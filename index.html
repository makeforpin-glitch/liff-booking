<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>支點運動_私課預約</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#111;
      --muted:#7a7a7a;
      --primary:#1bb57a;
      --border:rgba(0,0,0,.08);
      --shadow:0 10px 26px rgba(0,0,0,.08);
      --radius:18px;
      --danger:#b23a2b;
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      overflow:hidden;            /* ✅ 不要整頁往下滑 */
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    /* ✅ 整體滿版 */
    .wrap{
      height:100dvh;              /* ✅ 以手機可用高度為準 */
      display:flex;
      flex-direction:column;
      max-width:560px;
      margin:0 auto;
    }

    .top{
      padding:10px 14px 8px;
      padding-top: calc(10px + var(--safeT));
      background:linear-gradient(180deg, rgba(246,247,248,1) 75%, rgba(246,247,248,0));
      flex:0 0 auto;
    }

    /* 標題靠左（你之前要） */
    .title{
      font-weight:950;
      font-size:22px;
      letter-spacing:.2px;
      padding:2px 2px 8px;
      text-align:left;
    }

    .steps{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    .step{
      display:flex; align-items:center; gap:10px;
      flex:1;
      justify-content:center;
      min-width:0;
    }
    .dot{
      width:34px; height:34px;
      border-radius:999px;
      background:#e9f7f0;
      color:var(--primary);
      font-weight:950;
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      font-size:16px;
    }
    .dot.active{ background:var(--primary); color:#fff; }

    /* ✅ 「選教練/選日期/選時段」放大 */
    .label{
      font-size:18px;
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .label.active{ color:var(--text); font-weight:950; }

    /* ✅ 內容區：固定高度、不捲動 */
    .main{
      flex:1 1 auto;
      overflow:hidden;  /* ✅ 內容區也不捲 */
      padding:0 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px;
      overflow:hidden; /* ✅ 避免內部把外面撐爆 */
    }

    /* Step 標題維持大，但別太誇張避免滿版裝不下 */
    .h{
      margin:0 0 8px;
      font-weight:950;
      font-size:36px;   /* ✅ 比你原本 44 小，換成更適合滿版 */
      letter-spacing:.2px;
      line-height:1.05;
    }

    /* ✅ 其他文字縮小（你上一輪要求） */
    .sub{
      margin:0 0 10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      font-weight:700;
    }

    /* Step1 coach */
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .chip{
      padding:16px 18px;
      border-radius:18px;
      background:#eeeeee;
      font-weight:950;
      font-size:22px;
      cursor:pointer;
      user-select:none;
      border:2px solid transparent;
      min-width:140px;
      text-align:center;
      flex:1 1 0;
    }
    .chip.sel{
      background:#dff4ea;
      border-color:rgba(27,181,122,.45);
      box-shadow:0 0 0 3px rgba(27,181,122,.16) inset;
    }

    /* coach intro (step2/3) */
    .coachIntro{
      display:flex;
      gap:12px;
      align-items:center;
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      padding:12px;
      background:#fff;
      flex:0 0 auto;
    }
    .avatar{
      width:56px; height:56px;
      border-radius:999px;
      overflow:hidden;
      border:3px solid rgba(0,0,0,.06);
      background:#ddd;
      flex:0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .coachMeta{ flex:1; min-width:0; }
    .coachName{
      font-weight:950;
      font-size:24px;
      margin:0 0 6px;
      line-height:1.1;
    }
    .tags{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tag{
      padding:8px 10px;
      border-radius:999px;
      background:#eaf8f2;
      border:2px solid rgba(27,181,122,.22);
      color:#157a55;
      font-weight:900;
      font-size:13px;  /* ✅ TAG 字縮小 */
      line-height:1;
    }

    /* Step2 layout：日曆 + tabs + slots 同畫面（不滑動） */
    .step2Box{
      display:flex;
      flex-direction:column;
      gap:10px;
      height:100%;
      min-height:0;
    }

    .cal{
      border-radius:20px;
      border:1px solid rgba(0,0,0,.08);
      padding:12px;
      background:#fff;
      flex:0 0 auto;
    }
    .calHead{
      display:grid;
      grid-template-columns:54px 1fr 54px;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
    }
    .calBtn{
      width:54px; height:54px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-size:30px;
      font-weight:950;
      color:#0d7a55;
    }
    .monthTitle{
      text-align:center;
      font-weight:950;
      font-size:28px;
      letter-spacing:.5px;
      line-height:1;
    }
    .dow{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:8px;
      margin:8px 0;
    }
    .dow div{
      text-align:center;
      color:#666;
      font-weight:900;
      font-size:16px;
    }
    .days{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:8px;
    }
    .dayBtn{
      height:66px;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;

      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:visible;
    }
    .dayBtn.disabled{
      opacity:.35;
      pointer-events:none;
      box-shadow:none;
    }
    .dNum{
      font-weight:950;
      font-size:20px;  /* ✅ 日期縮小 → 圈圈可完整 */
      line-height:1;
    }
    .dayBtn.sel{
      background:#eaf8f2;
      border-color:rgba(27,181,122,.22);
    }
    .dayBtn.sel::after{
      content:"";
      position:absolute;
      inset:8px;               /* ✅ 圈圈不會被裁切 */
      border-radius:999px;
      border:3px solid rgba(27,181,122,.55);
      box-shadow:0 0 0 5px rgba(27,181,122,.12);
      pointer-events:none;
    }

    /* ✅ tabs + slots：用剩餘空間，不要把頁面撐高 */
    .slotsArea{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap:34px;
      border-bottom:2px solid rgba(0,0,0,.08);
      padding-bottom:8px;
      flex:0 0 auto;
    }
    .tab{
      font-weight:950;
      font-size:24px; /* ✅ 上午下午晚上放大 */
      color:#666;
      cursor:pointer;
      user-select:none;
      position:relative;
      padding-bottom:10px;
    }
    .tab.active{ color:#111; }
    .tab.active::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:-2px;
      height:6px;
      background:var(--primary);
      border-radius:999px;
    }

    /* ✅ 時段格：固定行數，讓畫面不需要滑 */
    .slotGrid{
      flex:1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns:repeat(4, 1fr); /* ✅ 手機更像附圖的 4 顆一排 */
      gap:10px;
      align-content:start;
      overflow:hidden;
    }
    .slot{
      padding:10px 0;
      border-radius:999px;
      background:#ededed;
      font-weight:950;
      font-size:14px;   /* ✅ 其他文字縮小 */
      text-align:center;
      cursor:pointer;
      user-select:none;
      border:2px solid transparent;
      line-height:1;
    }
    .slot.sel{
      background:#dff4ea;
      border-color:rgba(27,181,122,.35);
      box-shadow:0 0 0 3px rgba(27,181,122,.14) inset;
    }
    .slot.disabled{ opacity:.35; pointer-events:none; }

    .warn{
      flex:0 0 auto;
      display:flex;
      gap:10px;
      align-items:flex-start;
      color:var(--danger);
      font-weight:900;
      font-size:14px;  /* ✅ 縮小 */
      line-height:1.35;
    }
    .warn .icon{ font-size:18px; line-height:1; }

    /* footer 固定在底部，避免滑動 */
    .footer{
      flex:0 0 auto;
      padding:10px 14px calc(12px + var(--safeB));
      background:linear-gradient(0deg, rgba(246,247,248,1) 72%, rgba(246,247,248,0));
    }
    .btnRow{
      display:flex;
      gap:12px;
    }
    .btn{
      flex:1;
      border:0;
      border-radius:18px;
      padding:16px 12px;
      font-size:22px;
      font-weight:950;
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .btnPrimary{ background:var(--primary); color:#fff; }
    .btnGhost{
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,.10);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .status{
      margin-top:8px;
      font-size:14px;
      color:var(--muted);
      text-align:center;
      font-weight:800;
      min-height:20px;
    }

    .hide{ display:none !important; }

    /* 小螢幕/短高度：再縮一點避免任何溢出 */
    @media (max-height:720px){
      .h{ font-size:32px; }
      .title{ font-size:20px; }
      .label{ font-size:17px; }
      .dayBtn{ height:62px; }
      .monthTitle{ font-size:26px; }
      .tab{ font-size:22px; }
      .btn{ font-size:20px; padding:14px 10px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="title">支點運動_私課預約</div>

    <div class="steps">
      <div class="step">
        <div id="dot1" class="dot active">1</div>
        <div id="lab1" class="label active">選教練</div>
      </div>
      <div class="step">
        <div id="dot2" class="dot">2</div>
        <div id="lab2" class="label">選日期</div>
      </div>
      <div class="step">
        <div id="dot3" class="dot">3</div>
        <div id="lab3" class="label">選時段</div>
      </div>
    </div>
  </div>

  <div class="main">
    <!-- Step 1 -->
    <div id="card1" class="card">
      <div class="h">Step 1｜選擇教練</div>
      <p class="sub">請先選擇教練，後續只會顯示可預約的日期與時段。</p>
      <div id="coachRow" class="row"></div>
    </div>

    <!-- Step 2：滿版彈窗感（日曆 + tabs + 時段同畫面） -->
    <div id="card2" class="card hide" style="flex:1; min-height:0;">
      <div class="step2Box">
        <div class="h">Step 2｜選擇日期</div>

        <div class="coachIntro">
          <div class="avatar"><img id="coachAvatar2" alt="" /></div>
          <div class="coachMeta">
            <div id="coachName2" class="coachName">—</div>
            <div id="coachTags2" class="tags"></div>
          </div>
        </div>

        <div class="cal">
          <div class="calHead">
            <div id="prevWeek" class="calBtn">‹</div>
            <div id="monthTitle" class="monthTitle">—</div>
            <div id="nextWeek" class="calBtn">›</div>
          </div>

          <div class="dow">
            <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
          </div>

          <div id="days" class="days"></div>
        </div>

        <!-- ✅ 選到日期就顯示：tab + 時段（同畫面、不滑動） -->
        <div class="slotsArea">
          <div class="tabs">
            <div class="tab active" data-tab="am">上午</div>
            <div class="tab" data-tab="pm">下午</div>
            <div class="tab" data-tab="night">晚上</div>
          </div>
          <div id="slotGrid2" class="slotGrid"></div>

          <div class="warn">
            <div class="icon">⚠️</div>
            <div>預約及取消需在開課前 1 小時完成。</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3（保留確認用，你之後可改成真的確認頁） -->
    <div id="card3" class="card hide">
      <div class="h">Step 3｜確認</div>
      <p class="sub" id="confirmText">—</p>
    </div>
  </div>

  <div class="footer">
    <div class="btnRow">
      <button id="btnBack" class="btn btnGhost hide">上一步</button>
      <button id="btnNext" class="btn btnPrimary" disabled>下一步</button>
    </div>
    <div id="status" class="status">載入中…</div>
  </div>
</div>

<script>
  const LIFF_ID = '2008631386-AEejMove';

  const COACHES = [
    {
      id:'coachA',
      name:'偉銘',
      avatar:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=240&q=80',
      tags:['肌力訓練','樂齡運動','青少年體能']
    },
    {
      id:'coachB',
      name:'教練 B',
      avatar:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=240&q=80',
      tags:['肌力訓練','姿勢調整','初學友善']
    },
  ];

  const ROOM = { id:'room1', name:'場地' };

  const state = {
    step: 1,
    uid: '',
    name: '',
    coach: null,
    weekStart: null, // Monday
    dateKey: null,
    tab: 'am',
    slot: null,
  };

  const $ = s => document.querySelector(s);

  const dot1=$('#dot1'), dot2=$('#dot2'), dot3=$('#dot3');
  const lab1=$('#lab1'), lab2=$('#lab2'), lab3=$('#lab3');
  const card1=$('#card1'), card2=$('#card2'), card3=$('#card3');
  const coachRow=$('#coachRow');
  const btnBack=$('#btnBack');
  const btnNext=$('#btnNext');
  const status=$('#status');

  const coachAvatar2=$('#coachAvatar2');
  const coachName2=$('#coachName2');
  const coachTags2=$('#coachTags2');

  const prevWeek=$('#prevWeek');
  const nextWeek=$('#nextWeek');
  const monthTitle=$('#monthTitle');
  const daysWrap=$('#days');
  const slotGrid2=$('#slotGrid2');
  const confirmText=$('#confirmText');

  function pad2(n){ return String(n).padStart(2,'0'); }
  function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function weekStartMonday(d){
    const x = startOfDay(d);
    const day = x.getDay(); // 0 Sun ... 6 Sat
    const diff = (day === 0 ? -6 : 1 - day);
    return addDays(x, diff);
  }
  function monthYearLabel(ws){
    return `${ws.getMonth()+1}月 ${ws.getFullYear()}`;
  }

  function setStep(n){
    state.step = n;
    [dot1,dot2,dot3].forEach((d,i)=>d.classList.toggle('active', i+1===n));
    [lab1,lab2,lab3].forEach((l,i)=>l.classList.toggle('active', i+1===n));
    card1.classList.toggle('hide', n!==1);
    card2.classList.toggle('hide', n!==2);
    card3.classList.toggle('hide', n!==3);
    btnBack.classList.toggle('hide', n===1);

    if(n===1){
      btnNext.textContent='下一步';
      btnNext.disabled = !state.coach;
      status.textContent = state.coach ? `已選擇教練：${state.coach.name}` : `${state.name || '您好'}，第一步請先選擇教練`;
    }else if(n===2){
      btnNext.textContent='下一步';
      btnNext.disabled = !state.dateKey;
      status.textContent = state.dateKey ? `已選日期：${state.dateKey}` : ''; // ✅ 沒選日期不顯示
    }else{
      btnNext.textContent='確認預約';
      btnNext.disabled = !(state.dateKey && state.slot);
      status.textContent = state.dateKey ? `已選日期：${state.dateKey}` : '';
      confirmText.textContent = `教練：${state.coach.name}｜日期：${state.dateKey || '—'}｜時間：${state.slot || '—'}`;
    }
  }

  function renderCoaches(){
    coachRow.innerHTML='';
    COACHES.forEach(c=>{
      const div=document.createElement('div');
      div.className='chip'+(state.coach?.id===c.id?' sel':'');
      div.textContent=c.name;
      div.onclick=()=>{
        state.coach=c;
        renderCoaches();
        btnNext.disabled=false;
        status.textContent = `已選擇教練：${c.name}`;
      };
      coachRow.appendChild(div);
    });
  }

  function renderCoachIntro(){
    if(!state.coach) return;
    coachAvatar2.src = state.coach.avatar;
    coachName2.textContent = state.coach.name;
    coachTags2.innerHTML='';
    state.coach.tags.forEach(t=>{
      const el=document.createElement('div');
      el.className='tag';
      el.textContent=t;
      coachTags2.appendChild(el);
    });
  }

  function renderWeek(){
    const ws = state.weekStart;
    monthTitle.textContent = monthYearLabel(ws);
    daysWrap.innerHTML='';

    const today0 = startOfDay(new Date());

    for(let i=0;i<7;i++){
      const d = addDays(ws, i);
      const key = ymd(d);

      const btn=document.createElement('div');
      btn.className='dayBtn';

      const isPast = startOfDay(d) < today0; // ✅ 過去日期不可點（今天可點）
      if(isPast) btn.classList.add('disabled');
      if(state.dateKey===key) btn.classList.add('sel');

      const num=document.createElement('div');
      num.className='dNum';
      num.textContent = d.getDate(); // ✅ 只顯示日期數字
      btn.appendChild(num);

      btn.onclick=()=>{
        if(isPast) return;
        state.dateKey=key;
        state.slot=null;
        renderWeek();
        renderSlotsStep2();
        btnNext.disabled=false;
        status.textContent = `已選日期：${state.dateKey}`; // ✅ 點選日期後才顯示
      };

      daysWrap.appendChild(btn);
    }
  }

  function goWeek(offset){
    state.weekStart = addDays(state.weekStart, offset*7);
    renderWeek();
  }

  function renderSlotsStep2(){
    // ✅ 沒選日期就先清空（不顯示任何時段，避免擠版面）
    slotGrid2.innerHTML='';
    if(!state.dateKey) return;

    const presets = {
      am:    ['05:00','06:00','07:00','08:00','09:00','10:00','11:00'],
      pm:    ['13:00','14:00','15:00','16:00','17:00'],
      night: ['18:00','19:00','20:00','21:00']
    };
    const list = presets[state.tab] || [];

    // 一小時後禁用（今天才需要）
    const selectedDate = new Date(state.dateKey+'T00:00:00');
    const nowPlus1h = new Date(Date.now()+60*60*1000);

    list.forEach(t=>{
      const [hh,mm]=t.split(':').map(Number);
      const dt = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), hh, mm, 0);
      const disabled = dt < nowPlus1h;

      const div=document.createElement('div');
      div.className='slot'+(disabled?' disabled':'')+(state.slot===t?' sel':'');
      div.textContent=t;
      div.onclick=()=>{
        if(disabled) return;
        state.slot=t;
        renderSlotsStep2();
        // Step2 仍要按「下一步」進 Step3
        btnNext.disabled = !state.dateKey;
      };
      slotGrid2.appendChild(div);
    });
  }

  function bindTabs(){
    document.querySelectorAll('.tab').forEach(el=>{
      el.onclick=()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
        state.tab = el.dataset.tab;
        state.slot = null;
        renderSlotsStep2();
      };
    });
  }

  async function init(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) liff.login();

    const profile = await liff.getProfile();
    state.uid = profile.userId;
    state.name = profile.displayName || '您好';

    renderCoaches();

    state.weekStart = weekStartMonday(new Date());
    renderWeek();
    bindTabs();
    renderSlotsStep2();

    btnBack.onclick=()=>{
      if(state.step===2) setStep(1);
      else if(state.step===3) setStep(2);
    };

    btnNext.onclick=async ()=>{
      if(state.step===1){
        setStep(2);
        renderCoachIntro();
        // Step2 初始不顯示狀態（沒選日期）
        status.textContent = '';
        return;
      }
      if(state.step===2){
        setStep(3);
        return;
      }

      // Step3：送關鍵字到聊天室
      const text = `#BOOK coach=${state.coach.id} room=${ROOM.id} date=${state.dateKey} time=${state.slot || ''} dur=60`;

      btnNext.disabled=true;
      status.textContent='送出中…';

      try{
        await liff.sendMessages([{ type:'text', text }]);
        status.textContent='✅ 已送出，回到聊天室處理預約…';
        setTimeout(()=>liff.closeWindow(), 600);
      }catch(e){
        status.textContent='❌ 送出失敗，請重試（請確認是在 LINE 內開啟）';
        btnNext.disabled=false;
      }
    };

    prevWeek.onclick=()=>goWeek(-1);
    nextWeek.onclick=()=>goWeek(1);

    setStep(1);
  }

  init();
</script>
</body>
</html>
