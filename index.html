<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ”¯é»é‹å‹•_ç§èª²é ç´„</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#111;
      --muted:#7a7a7a;
      --primary:#1bb57a;
      --border:rgba(0,0,0,.08);
      --shadow:0 10px 26px rgba(0,0,0,.08);
      --radius:18px;
      --danger:#b23a2b; /* æš—ç´… */
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
      --warnBg:#fff7e6;
      --warnBorder:rgba(192,122,0,.18);
      --warnText:#7a4a00;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow:hidden; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    .wrap{
      height:100dvh;
      display:flex;
      flex-direction:column;
      max-width:560px;
      margin:0 auto;
    }

    .top{
      padding:10px 14px 8px;
      padding-top: calc(10px + var(--safeT));
      background:linear-gradient(180deg, rgba(246,247,248,1) 75%, rgba(246,247,248,0));
      flex:0 0 auto;
    }

    .title{ display:none; }

    .steps{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    .step{
      display:flex; align-items:center; gap:8px;
      flex:1;
      justify-content:center;
      min-width:0;
    }
    .dot{
      width:30px; height:30px;
      border-radius:999px;
      background:#e9f7f0;
      color:var(--primary);
      font-weight:900;
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      font-size:14px;
    }
    .dot.active{ background:var(--primary); color:#fff; }

    .label{
      font-size:15px;
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .label.active{ color:var(--text); }

    .main{
      flex:1 1 auto;
      overflow:hidden;
      padding:0 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px;
      overflow:hidden;
    }

    .h{
      margin:0 0 10px;
      font-weight:950;
      font-size:22px;
      letter-spacing:.2px;
      line-height:1.1;
      color:#111;
      text-align:left;
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap; }

    /* æ•™ç·´æŒ‰éˆ• */
    .chip{
      padding:14px 16px;
      border-radius:16px;
      background:#eeeeee;
      font-weight:950;
      font-size:18px;
      cursor:pointer;
      user-select:none;
      border:2px solid transparent;
      min-width:140px;
      text-align:center;
      flex:1 1 0;
      position:relative;
      overflow:hidden;
    }
    .chip.sel{
      background:#dff4ea;
      border-color:rgba(27,181,122,.45);
      box-shadow:0 0 0 3px rgba(27,181,122,.14) inset;
    }
    .chip.disabled{
      opacity:.55;
      pointer-events:none;
    }

    /* Step1 äººæ•¸å€æ¨™é¡Œ */
    .subTitle{
      margin:14px 0 10px;
      font-weight:950;
      font-size:15px;
      color:#111;
    }

    /* äººæ•¸ chip */
    .chip.peoplemp{
      flex:1 1 0;
      min-width:140px;
      font-size:18px;
    }

    .coachIntro{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:10px;
      background:#fff;
      flex:0 0 auto;
    }
    .avatar{
      width:48px; height:48px;
      border-radius:999px;
      overflow:hidden;
      border:3px solid rgba(0,0,0,.06);
      background:#ddd;
      flex:0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .coachMeta{ flex:1; min-width:0; }
    .coachName{
      font-weight:950;
      font-size:18px;
      margin:0 0 6px;
      line-height:1.1;
    }
    .tags{ display:flex; gap:6px; flex-wrap:wrap; }
    .tag{
      padding:6px 9px;
      border-radius:999px;
      background:#eaf8f2;
      border:1px solid rgba(27,181,122,.22);
      color:#157a55;
      font-weight:900;
      font-size:11px;
      line-height:1;
    }

    .step2Box{
      display:flex;
      flex-direction:column;
      gap:10px;
      height:100%;
      min-height:0;
    }

    .cal{
      border-radius:18px;
      border:1px solid rgba(0,0,0,.08);
      padding:10px;
      background:#fff;
      flex:0 0 auto;
    }
    .calHead{
      display:grid;
      grid-template-columns:42px 1fr 42px;
      gap:10px;
      align-items:center;
      margin-bottom:6px;
    }
    .calBtn{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-size:22px;
      font-weight:950;
      color:#0d7a55;
    }
    /* ç•¶æœˆä»½ç„¡æ³•åˆ‡æ›æ™‚çš„æ¨£å¼ */
    .calBtn.disabled {
      opacity: 0.3;
      pointer-events: none;
      box-shadow: none;
      background: #f0f0f0;
      color: #999;
    }

    .monthTitle{
      text-align:center;
      font-weight:950;
      font-size:16px;
      letter-spacing:.2px;
      line-height:1;
    }

    .weekStrip{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:8px;
    }
    .dayCell{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      padding:6px 0;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.06);
      background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
      cursor:pointer;
      user-select:none;
      min-height:64px;
      position:relative;
    }
    .dayCell.disabled{
      opacity:.35;
      pointer-events:none;
      box-shadow:none;
    }
    /* éš±è—è¶…éæˆªæ­¢æ—¥çš„æ—¥æœŸ */
    .dayCell.hidden {
      visibility: hidden;
      pointer-events: none;
    }

    .dowTxt{
      font-size:11px;
      font-weight:900;
      color:#666;
      line-height:1;
    }
    .dateDot{
      width:34px;
      height:34px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      font-weight:950;
      color:#111;
      background:transparent;
      border:2px solid transparent;
    }
    .dayCell.sel .dateDot{
      background:var(--primary);
      color:#fff;
      border-color:rgba(27,181,122,.25);
      box-shadow:0 0 0 5px rgba(27,181,122,.14);
    }

    .slotsArea{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }
    .tabs{
      display:flex;
      gap:22px;
      border-bottom:2px solid rgba(0,0,0,.08);
      padding-bottom:8px;
      flex:0 0 auto;
    }
    .tab{
      font-weight:950;
      font-size:16px;
      color:#666;
      cursor:pointer;
      user-select:none;
      position:relative;
      padding-bottom:10px;
    }
    .tab.active{ color:#111; }
    .tab.active::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:-2px;
      height:5px;
      background:var(--primary);
      border-radius:999px;
    }

    .slotGrid{
      flex:1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:10px;
      align-content:start;
      overflow:auto;
      padding-right:2px;
      -webkit-overflow-scrolling:touch;
    }
    .slot{
      padding:10px 0;
      border-radius:999px;
      background:#ededed;
      font-weight:950;
      font-size:13px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      border:2px solid transparent;
      line-height:1;
      white-space:nowrap;
    }
    .slot.sel{
      background:#dff4ea;
      border-color:rgba(27,181,122,.35);
      box-shadow:0 0 0 3px rgba(27,181,122,.14) inset;
    }
    .slot.disabled{ opacity:.35; pointer-events:none; }

    .slotTip{
      grid-column:1 / -1;
      padding:8px 2px;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      line-height:1.4;
    }
    .slotTip.important{
      color:var(--danger);
      font-weight:950;
      font-size:14px;
    }
    .slotTip.error{
      color:var(--danger);
      font-weight:950;
      font-size:12px;
    }

    .warn{
      flex:0 0 auto;
      display:flex;
      gap:10px;
      align-items:flex-start;
      color:#c07a00;
      font-weight:900;
      font-size:12px;
      line-height:1.35;
      background:var(--warnBg);
      border:1px solid var(--warnBorder);
      border-radius:14px;
      padding:10px;
    }
    .warn .icon{ font-size:16px; line-height:1; }

    .confirmWrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:4px 0 2px;
      min-height:0;
    }

    .infoBox{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      background:#f3f8f6;
      padding:12px;
      font-size:15px;
      line-height:1.8;
      font-weight:900;
      color:#1f3b2f;
    }
    .infoLine{ margin:3px 0; }
    .infoLine b{
      font-weight:950;
      font-size:16px;
    }

    .remindTitle{
      width:100%;
      font-weight:950;
      font-size:12px;
      color:#c07a00;
      margin-top:2px;
    }

    .remindBox{
      width:100%;
      border-radius:16px;
      border:1px solid var(--warnBorder);
      background:var(--warnBg);
      padding:12px;
      font-size:12px;
      line-height:1.6;
      font-weight:900;
      color:var(--warnText);
    }

    .footer{
      flex:0 0 auto;
      padding:10px 14px calc(12px + var(--safeB));
      background:linear-gradient(0deg, rgba(246,247,248,1) 72%, rgba(246,247,248,0));
    }
    .btnRow{
      display:flex;
      gap:12px;
    }
    .btn{
      flex:1;
      border:0;
      border-radius:16px;
      padding:14px 12px;
      font-size:16px;
      font-weight:950;
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .btnPrimary{ background:var(--primary); color:#fff; }
    .btnGhost{
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,.10);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .status{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
      font-weight:900;
      min-height:18px;
      white-space:pre-wrap;
    }
    .statusError{ color:var(--danger); font-weight:950; }

    .hide{ display:none !important; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="title">æ”¯é»é‹å‹•_ç§èª²é ç´„</div>

    <div class="steps">
      <div class="step">
        <div id="dot1" class="dot active">1</div>
        <div id="lab1" class="label active">é¸æ•™ç·´</div>
      </div>
      <div class="step">
        <div id="dot2" class="dot">2</div>
        <div id="lab2" class="label">é¸æ—¥æœŸ</div>
      </div>
      <div class="step">
        <div id="dot3" class="dot">3</div>
        <div id="lab3" class="label">ç¢ºèª</div>
      </div>
    </div>
  </div>

  <div class="main">
    <div id="card1" class="card">
      <div class="h">Step 1ï½œé¸æ“‡æ•™ç·´</div>
      <div id="coachRow" class="row"></div>

      <div class="subTitle">é¸æ“‡äººæ•¸</div>
      <div id="peopleRow" class="row"></div>
    </div>

    <div id="card2" class="card hide" style="flex:1; min-height:0;">
      <div class="step2Box">
        <div class="h">Step 2ï½œé¸æ“‡æ—¥æœŸåŠæ™‚æ®µ</div>

        <div class="coachIntro">
          <div class="avatar"><img id="coachAvatar2" alt="" /></div>
          <div class="coachMeta">
            <div id="coachName2" class="coachName">â€”</div>
            <div id="coachTags2" class="tags"></div>
          </div>
        </div>

        <div class="cal">
          <div class="calHead">
            <div id="prevWeek" class="calBtn">â€¹</div>
            <div id="monthTitle" class="monthTitle">â€”</div>
            <div id="nextWeek" class="calBtn">â€º</div>
          </div>

          <div id="weekStrip" class="weekStrip"></div>
        </div>

        <div class="slotsArea">
          <div class="tabs">
            <div class="tab active" data-tab="am">ä¸Šåˆ</div>
            <div class="tab" data-tab="pm">ä¸‹åˆ</div>
            <div class="tab" data-tab="night">æ™šä¸Š</div>
          </div>

          <div id="slotGrid2" class="slotGrid"></div>

          <div class="warn">
            <div class="icon">ğŸ””</div>
            <div>é ç´„åŠå–æ¶ˆéœ€åœ¨é–‹èª²å‰ 1 å°æ™‚å®Œæˆã€‚</div>
          </div>
        </div>
      </div>
    </div>

    <div id="card3" class="card hide" style="flex:1; min-height:0;">
      <div class="confirmWrap">
        <div class="h">Step 3ï½œç¢ºèªé ç´„è¨Šæ¯</div>

        <div class="infoBox" id="confirmInfo"></div>

        <div class="remindTitle">æº«é¦¨æé†’</div>
        <div class="remindBox">
          1. è‹¥éœ€å–æ¶ˆæˆ–æ”¹æœŸï¼Œè«‹æ–¼é–‹èª²å‰ 1 å°æ™‚å®Œæˆã€‚<br/>
          2. å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹æ–¼ã€Œæ”¯é»é‹å‹•ç©ºé–“ã€å®˜æ–¹Lineè¯ç¹«ã€‚
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="btnRow">
      <button id="btnBack" class="btn btnGhost hide">ä¸Šä¸€æ­¥</button>
      <button id="btnNext" class="btn btnPrimary" disabled>ä¸‹ä¸€æ­¥</button>
    </div>
    <div id="status" class="status">è¼‰å…¥ä¸­â€¦</div>
  </div>
</div>

<script>
  const LIFF_ID = '2008631386-AEejMove';

  /**
   * Make Webhook URLs
   */
  const MAKE_OPTIONS_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';
  const MAKE_BOOKING_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';

  const COACHES = [
    {
      id:'coachA',
      name:'å‰éŠ˜',
      avatar:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=240&q=80',
      tags:['è‚ŒåŠ›è¨“ç·´','æ¨‚é½¡é‹å‹•','é’å°‘å¹´é«”èƒ½']
    },
    {
      id:'coachB',
      name:'æ•™ç·´ B',
      avatar:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=240&q=80',
      tags:['è‚ŒåŠ›è¨“ç·´','å§¿å‹¢èª¿æ•´','åˆå­¸å‹å–„']
    },
  ];

  const state = {
    step: 1,
    uid: '',
    name: '',
    coach: null,
    people: null, // 1 æˆ– 2

    weekStart: null,
    dateKey: null,
    tab: 'am',
    slot: null,

    // å¾ Make å›ä¾†çš„å¯é ç´„è³‡æ–™
    optionsRaw: [],              // [{label,value}...]
    availabilityMap: {},         // { "YYYY-MM-DD": ["08:00","09:00"...] }
    loadingOptions: false
  };

  const $ = s => document.querySelector(s);

  const dot1=$('#dot1'), dot2=$('#dot2'), dot3=$('#dot3');
  const lab1=$('#lab1'), lab2=$('#lab2'), lab3=$('#lab3');
  const card1=$('#card1'), card2=$('#card2'), card3=$('#card3');
  const coachRow=$('#coachRow');
  const peopleRow=$('#peopleRow');
  const btnBack=$('#btnBack');
  const btnNext=$('#btnNext');
  const status=$('#status');

  const coachAvatar2=$('#coachAvatar2');
  const coachName2=$('#coachName2');
  const coachTags2=$('#coachTags2');

  const prevWeek=$('#prevWeek');
  const nextWeek=$('#nextWeek');
  const monthTitle=$('#monthTitle');
  const weekStrip=$('#weekStrip');
  const slotGrid2=$('#slotGrid2');

  const confirmInfo=$('#confirmInfo');

  function pad2(n){ return String(n).padStart(2,'0'); }
  function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function weekStartMonday(d){
    const x = startOfDay(d);
    const day = x.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    return addDays(x, diff);
  }
  function monthYearLabel(ws){ return `${ws.getMonth()+1}æœˆ ${ws.getFullYear()}`; }
  function dowLabel(idx){ return ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][idx] || ''; }

  function weekdayZhFromDateKey(dateKey){
    const d = new Date(dateKey + 'T00:00:00');
    const map = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    return map[d.getDay()] || '';
  }

  // è¨ˆç®—å¯é ç´„æœŸé™ï¼ˆä¸‹å€‹æœˆæœˆåº•ï¼Œè¨­å®šåˆ°æœ€å¾Œä¸€ç§’ï¼‰
  function getLimitDate(){
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth() + 2, 0);
    d.setHours(23, 59, 59, 999);
    return d;
  }

  function canBookNow(dateKey, timeStr){
    if(!dateKey || !timeStr) return false;
    const selectedDate = new Date(dateKey+'T00:00:00');
    const [hh,mm]=timeStr.split(':').map(Number);
    const dt = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), hh, mm, 0);
    const nowPlus1h = new Date(Date.now()+60*60*1000);
    return dt >= nowPlus1h;
  }

  function setStatus(msg, isError=false){
    status.classList.toggle('statusError', !!isError);
    status.textContent = msg || '';
  }

  function getHelloName(){
    const raw = (state.name && String(state.name).trim()) ? String(state.name).trim() : 'user';
    return raw;
  }

  function step1StatusText(){
    if(!state.coach){
      return `${getHelloName()}æ‚¨å¥½ï¼Œè«‹é¸æ“‡æ•™ç·´`;
    }
    if(!state.people){
      return `å·²é¸æ“‡æ•™ç·´ï¼š${state.coach.name}\nè«‹é¸æ“‡äººæ•¸ï¼ˆæœ€å¤š 2 äººï¼‰`;
    }
    return `å·²é¸æ“‡æ•™ç·´ï¼š${state.coach.name}ï½œäººæ•¸ï¼š${state.people} äºº`;
  }

  function setStep(n){
    state.step = n;

    [dot1,dot2,dot3].forEach((d,i)=>d.classList.toggle('active', i+1===n));
    [lab1,lab2,lab3].forEach((l,i)=>l.classList.toggle('active', i+1===n));

    card1.classList.toggle('hide', n!==1);
    card2.classList.toggle('hide', n!==2);
    card3.classList.toggle('hide', n!==3);

    status.classList.remove('statusError');

    if(n===1){
      btnBack.classList.add('hide');
      btnNext.textContent='ä¸‹ä¸€æ­¥';
      btnNext.disabled = !(state.coach && state.people);
      setStatus(step1StatusText());
    }

    if(n===2){
      btnBack.classList.remove('hide');
      btnNext.textContent='ä¸‹ä¸€æ­¥';
      btnNext.disabled = state.loadingOptions || !(state.coach && state.people && state.dateKey && state.slot);

      if(state.loadingOptions){
        setStatus(`å·²é¸æ“‡æ•™ç·´ï¼š${state.coach?.name || 'â€”'}ï½œäººæ•¸ï¼š${state.people || 'â€”'} äºº\nè®€å–å¯é ç´„æ™‚æ®µä¸­â€¦`);
      }else{
        if(!hasAnySlots()){
          setStatus('ç›®å‰æ²’æœ‰å¯é ç´„çš„æ™‚æ®µ', true);
        }else{
          setStatus(state.dateKey ? `å·²é¸æ—¥æœŸï¼š${state.dateKey}${state.slot ? `ï½œå·²é¸æ™‚æ®µï¼š${state.slot}`:''}` : 'è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ—¥æœŸ');
        }
      }
    }

    if(n===3){
      btnBack.classList.remove('hide');
      btnNext.textContent='ç¢ºèªé ç´„';
      btnNext.disabled = !(state.coach && state.people && state.dateKey && state.slot);

      const wd = state.dateKey ? weekdayZhFromDateKey(state.dateKey) : '';
      
      const infoHTML = `
        <div class="infoLine"><b>é ç´„æ•™ç·´ï¼š</b>${state.coach?.name || 'â€”'}</div>
        <div class="infoLine"><b>é ç´„äººæ•¸ï¼š</b>${state.people ? `${state.people} äºº` : 'â€”'}</div>
        <div class="infoLine"><b>é ç´„æ™‚é–“ï¼š</b>${state.dateKey ? `${state.dateKey} (${wd})` : 'â€”'} ${state.slot || 'â€”'}</div>
      `;
      confirmInfo.innerHTML = infoHTML;

      setStatus('');
    }
  }

  function renderCoaches(){
    coachRow.innerHTML='';
    COACHES.forEach(c=>{
      const div=document.createElement('div');
      div.className='chip'+(state.coach?.id===c.id?' sel':'');
      div.textContent=c.name;

      div.onclick=()=>{
        state.coach=c;
        renderCoaches();
        renderPeople();
        btnNext.disabled = !(state.coach && state.people);
        setStatus(step1StatusText());
      };

      coachRow.appendChild(div);
    });
  }

  function renderPeople(){
    peopleRow.innerHTML='';
    [1,2].forEach(n=>{
      const div=document.createElement('div');
      div.className = 'chip chipmp' + (state.people===n ? ' sel' : '');
      div.textContent = `${n} äºº`;

      div.onclick=()=>{
        state.people = n;
        renderPeople();
        btnNext.disabled = !(state.coach && state.people);
        setStatus(step1StatusText());
      };

      if(!state.coach){
        div.classList.add('disabled');
      }

      peopleRow.appendChild(div);
    });
  }

  function renderCoachIntro(){
    if(!state.coach) return;
    coachAvatar2.src = state.coach.avatar;
    coachName2.textContent = state.coach.name;
    coachTags2.innerHTML='';
    state.coach.tags.forEach(t=>{
      const el=document.createElement('div');
      el.className='tag';
      el.textContent=t;
      coachTags2.appendChild(el);
    });
  }

  function hasAnySlots(){
    return state.optionsRaw && Array.isArray(state.optionsRaw) && state.optionsRaw.length > 0;
  }

  function buildAvailabilityMap(options){
    const map = {};
    (options || []).forEach(o=>{
      const raw = (o && (o.value || o.label)) ? String(o.value || o.label) : '';
      const m = raw.match(/^(\d{4})[\/-](\d{2})[\/-](\d{2})\s+(\d{2}:\d{2})$/);
      if(!m) return;
      const dateKey = `${m[1]}-${m[2]}-${m[3]}`;
      const time = m[4];
      if(!map[dateKey]) map[dateKey] = [];
      if(!map[dateKey].includes(time)) map[dateKey].push(time);
    });

    Object.keys(map).forEach(k=>{
      map[k].sort((a,b)=>a.localeCompare(b));
    });

    return map;
  }

  function datesWithSlotsSet(){
    return new Set(Object.keys(state.availabilityMap || {}));
  }

  // æ¸²æŸ“é€±æ›†é‚è¼¯ (éš±è—è¶…å‡ºæ—¥æœŸçš„æ ¼å­)
  function renderWeekStrip(){
    const ws = state.weekStart;
    monthTitle.textContent = monthYearLabel(ws);
    weekStrip.innerHTML='';

    const today0 = startOfDay(new Date());
    const dateSet = datesWithSlotsSet();
    const limitDate = getLimitDate(); // å–å¾—æˆªæ­¢æ—¥(ä¸‹å€‹æœˆæœˆåº•)
    const thisWeekStart = weekStartMonday(new Date()); // å–å¾—æœ¬é€±ä¸€

    // 1. æ§åˆ¶ã€Œä¸Šä¸€æ­¥ã€æŒ‰éˆ•
    if(ws <= thisWeekStart){
      prevWeek.classList.add('disabled');
    } else {
      prevWeek.classList.remove('disabled');
    }

    // 2. æ§åˆ¶ã€Œä¸‹ä¸€æ­¥ã€æŒ‰éˆ•
    const nextWeekStart = addDays(ws, 7);
    if(nextWeekStart > limitDate){
      nextWeek.classList.add('disabled');
    } else {
      nextWeek.classList.remove('disabled');
    }

    for(let i=0;i<7;i++){
      const d = addDays(ws, i);
      const key = ymd(d);

      const cell=document.createElement('div');
      cell.className='dayCell';

      const isPast = startOfDay(d) < today0;
      const noSlots = !dateSet.has(key);
      const isOverLimit = d > limitDate; // è¶…éæˆªæ­¢æ—¥çš„æ—¥æœŸ

      if(isPast || noSlots || isOverLimit || state.loadingOptions) cell.classList.add('disabled');
      
      // å¦‚æœè©²æ—¥æœŸè¶…éæˆªæ­¢æ—¥ï¼Œç›´æ¥éš±è—
      if(isOverLimit) {
        cell.classList.add('hidden');
      }

      if(state.dateKey===key) cell.classList.add('sel');

      const dow=document.createElement('div');
      dow.className='dowTxt';
      dow.textContent = dowLabel(i);

      const dot=document.createElement('div');
      dot.className='dateDot';
      dot.textContent = d.getDate();

      cell.appendChild(dow);
      cell.appendChild(dot);

      cell.onclick=()=>{
        if(isPast || noSlots || isOverLimit || state.loadingOptions) return;
        state.dateKey=key;
        state.slot=null;
        renderWeekStrip();
        renderSlotsStep2();
        setStatus(`å·²é¸æ—¥æœŸï¼š${state.dateKey}`);
        btnNext.disabled = state.loadingOptions || !(state.coach && state.people && state.dateKey && state.slot);
      };

      weekStrip.appendChild(cell);
    }
  }

  function goWeek(offset){
    const newStart = addDays(state.weekStart, offset*7);
    const thisWeekStart = weekStartMonday(new Date());
    const limitDate = getLimitDate();

    // å¾€å›åˆ‡ï¼šä¸èƒ½å°æ–¼æœ¬é€±
    if(offset < 0 && newStart < thisWeekStart) return;
    
    // å¾€å¾Œåˆ‡ï¼šèµ·å§‹æ—¥ä¸èƒ½å¤§æ–¼æˆªæ­¢æ—¥
    if(offset > 0 && newStart > limitDate) return;

    state.weekStart = newStart;
    renderWeekStrip();
    renderSlotsStep2();
  }

  function filterTimesByTab(times, tab){
    const list = (times || []).filter(t=>{
      const hh = parseInt(t.split(':')[0], 10);
      if(tab==='am') return hh >= 5 && hh <= 11;
      if(tab==='pm') return hh >= 12 && hh <= 17;
      return hh >= 18 && hh <= 23;
    });
    return list;
  }

  function appendTip(text, cls){
    const tip=document.createElement('div');
    tip.className = `slotTip ${cls || ''}`.trim();
    tip.textContent=text;
    slotGrid2.appendChild(tip);
  }

  function renderSlotsStep2(){
    slotGrid2.innerHTML='';

    if(state.loadingOptions){
      appendTip('è®€å–å¯é ç´„æ™‚æ®µä¸­â€¦', 'important');
      return;
    }

    if(!hasAnySlots()){
      appendTip('ç›®å‰æ²’æœ‰å¯é ç´„çš„æ™‚æ®µ', 'error');
      return;
    }

    if(!state.dateKey){
      appendTip('è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ—¥æœŸ', 'important');
      return;
    }

    const times = state.availabilityMap[state.dateKey] || [];
    const list = filterTimesByTab(times, state.tab);

    if(list.length===0){
      // âœ… ä¿®æ”¹ï¼šå°‡æ–‡å­—æ”¹ç‚º 'important' classï¼Œä½¿å…¶è®Šå¤§è®Šç´…
      appendTip('æ­¤æ—¥æœŸæ–¼æ­¤æ™‚æ®µï¼Œæœªé–‹æ”¾å¯é ç´„æ™‚é–“', 'important');
      return;
    }

    list.forEach(t=>{
      const disabled = !canBookNow(state.dateKey, t);

      const div=document.createElement('div');
      div.className='slot'+(disabled?' disabled':'')+(state.slot===t?' sel':'');
      div.textContent=t;

      div.onclick=()=>{
        if(disabled) return;
        state.slot=t;
        renderSlotsStep2();
        setStatus(`å·²é¸æ—¥æœŸï¼š${state.dateKey}ï½œå·²é¸æ™‚æ®µï¼š${state.slot}`);
        btnNext.disabled = state.loadingOptions || !(state.coach && state.people && state.dateKey && state.slot);
      };

      slotGrid2.appendChild(div);
    });
  }

  function bindTabs(){
    document.querySelectorAll('.tab').forEach(el=>{
      el.onclick=()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
        state.tab = el.dataset.tab;
        state.slot = null;
        renderSlotsStep2();
        btnNext.disabled = state.loadingOptions || !(state.coach && state.people && state.dateKey && state.slot);
      };
    });
  }

  async function fetchOptionsFromMake(){
    if(!MAKE_OPTIONS_WEBHOOK_URL){
      state.optionsRaw = [];
      state.availabilityMap = {};
      return;
    }

    const payload = {
      action: "getOptions",
      coachName: state.coach?.name || "",
      coachId: state.coach?.id || "",
      people: state.people || 0,
      userId: state.uid || ""
    };

    const res = await fetch(MAKE_OPTIONS_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const t = await res.text().catch(()=> '');
      throw new Error(`Make options webhook failed: ${res.status} ${t}`);
    }

    const data = await res.json();
    const options = data && Array.isArray(data.options) ? data.options : [];

    state.optionsRaw = options;
    state.availabilityMap = buildAvailabilityMap(options);
  }

  async function loadOptionsForCoach(){
    state.loadingOptions = true;
    state.optionsRaw = [];
    state.availabilityMap = {};
    state.dateKey = null;
    state.slot = null;

    setStep(2);
    renderCoachIntro();
    renderWeekStrip();
    renderSlotsStep2();

    try{
      setStatus(`å·²é¸æ“‡æ•™ç·´ï¼š${state.coach?.name || 'â€”'}ï½œäººæ•¸ï¼š${state.people || 'â€”'} äºº\nè®€å–å¯é ç´„æ™‚æ®µä¸­â€¦`);
      await fetchOptionsFromMake();

      state.loadingOptions = false;

      renderWeekStrip();
      renderSlotsStep2();

      if(!hasAnySlots()){
        setStatus('ç›®å‰æ²’æœ‰å¯é ç´„çš„æ™‚æ®µ', true);
      }else{
        setStatus('è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ—¥æœŸ');
      }

      btnNext.disabled = state.loadingOptions || !(state.coach && state.people && state.dateKey && state.slot);
    }catch(e){
      state.loadingOptions = false;
      state.optionsRaw = [];
      state.availabilityMap = {};
      renderWeekStrip();
      renderSlotsStep2();
      setStatus(`è®€å–å¤±æ•—ï¼š${e.message}`, true);
      btnNext.disabled = true;
    }
  }

  function buildBookingData(){
    const weekday = state.dateKey ? weekdayZhFromDateKey(state.dateKey) : "";
    return {
      action: "book",
      userId: state.uid,
      displayName: state.name,
      coachName: state.coach?.name,
      people: state.people,
      date: state.dateKey,
      time: state.slot,
      weekday,
      createdAt: new Date().toISOString()
    };
  }

  async function postBookingToMake(data){
    if(!MAKE_BOOKING_WEBHOOK_URL) return { ok:true, skipped:true };
    try{
      const res = await fetch(MAKE_BOOKING_WEBHOOK_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(data)
      });
      const text = await res.text().catch(()=> '');
      if(!res.ok) throw new Error(`Make booking webhook failed: ${res.status} ${text}`);
      return { ok:true, status: res.status, body: text };
    }catch(e){
      return { ok:false, error:e };
    }
  }

  function buildSuccessFlex(){
    const coachName = state.coach?.name || 'â€”';
    const wd = state.dateKey ? weekdayZhFromDateKey(state.dateKey) : '';
    const whenText = `${state.dateKey || 'â€”'} (${wd}) ${state.slot || 'â€”'}`;
    const peopleText = state.people ? `${state.people} äºº` : 'â€”';

    return [{
      type: "flex",
      altText: "ç§èª²é ç´„æˆåŠŸ",
      contents: {
        type: "bubble",
        size: "mega",
        header: {
          type: "box",
          layout: "vertical",
          backgroundColor: "#1bb57a",
          paddingAll: "16px",
          contents: [
            { type: "text", text: "ç§èª²é ç´„æˆåŠŸ", color: "#ffffff", weight: "bold", size: "xl" },
            { type: "text", text: "æ”¯é»é‹å‹•ç©ºé–“", color: "#E7FFF5", size: "sm", margin: "sm" }
          ]
        },
        body: {
          type: "box",
          layout: "vertical",
          spacing: "md",
          paddingAll: "16px",
          contents: [
            {
              type: "box",
              layout: "vertical",
              backgroundColor: "#F3F8F6",
              cornerRadius: "12px",
              paddingAll: "12px",
              contents: [
                {
                  type: "box",
                  layout: "baseline",
                  spacing: "md",
                  contents: [
                    { type: "text", text: "é ç´„æ•™ç·´", size: "md", weight: "bold", color: "#1F3B2F", flex: 0 },
                    { type: "text", text: coachName, size: "md", weight: "bold", color: "#1F3B2F", wrap: true }
                  ]
                },
                {
                  type: "box",
                  layout: "baseline",
                  spacing: "md",
                  margin: "sm",
                  contents: [
                    { type: "text", text: "é ç´„äººæ•¸", size: "md", weight: "bold", color: "#1F3B2F", flex: 0 },
                    { type: "text", text: peopleText, size: "md", weight: "bold", color: "#1F3B2F", wrap: true }
                  ]
                },
                {
                  type: "box",
                  layout: "baseline",
                  spacing: "md",
                  margin: "sm",
                  contents: [
                    { type: "text", text: "é ç´„æ™‚é–“", size: "md", weight: "bold", color: "#1F3B2F", flex: 0 },
                    { type: "text", text: whenText, size: "sm", weight: "bold", color: "#1F3B2F", wrap: true }
                  ]
                }
              ]
            },
            { type: "text", text: "æº«é¦¨æé†’", color: "#7A4A00", weight: "bold", size: "xs", margin: "md" },
            {
              type: "text",
              wrap: true,
              color: "#7A4A00",
              size: "xs",
              text:
                "1. å–æ¶ˆæˆ–æ”¹æœŸï¼Œè«‹æ–¼é–‹èª²å‰1å°æ™‚å®Œæˆã€‚\n" +
                "2. å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹æ–¼ã€Œæ”¯é»é‹å‹•ç©ºé–“ã€å®˜æ–¹Lineè¯ç¹«æˆ‘å€‘ã€‚"
            }
          ]
        }
      }
    }];
  }

  async function sendFlexToChat(){
    await liff.sendMessages(buildSuccessFlex());
  }

  function errToText(e){
    try{
      if(!e) return 'unknown';
      const name = e.name || '';
      const message = e.message || '';
      const code = e.code ? ` code=${e.code}` : '';
      return `${name}${code} ${message}`.trim();
    }catch(_){
      return 'unknown';
    }
  }

  async function init(){
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()) liff.login();

    const profile = await liff.getProfile();
    state.uid = profile.userId;
    state.name = profile.displayName || '';

    renderCoaches();
    renderPeople();
    state.weekStart = weekStartMonday(new Date());
    renderWeekStrip();
    bindTabs();
    renderSlotsStep2();

    btnBack.onclick=()=>{
      if(state.step===2) setStep(1);
      else if(state.step===3) setStep(2);
    };

    btnNext.onclick=async ()=>{
      if(state.step===1){
        if(!(state.coach && state.people)) return;
        await loadOptionsForCoach();
        return;
      }

      if(state.step===2){
        if(state.loadingOptions) return;
        if(!(state.coach && state.people && state.dateKey && state.slot)) return;
        setStep(3);
        return;
      }

      if(state.step===3){
        if(!(state.coach && state.people && state.dateKey && state.slot)) return;

        btnNext.disabled = true;
        setStatus(`é€å‡ºä¸­â€¦`);

        if(!liff.isInClient()){
          setStatus(`âŒ ç›®å‰ä¸æ˜¯åœ¨ LINE å…§é–‹å•Ÿ`, true);
          btnNext.disabled = false;
          return;
        }

        const bookingData = buildBookingData();
        const mk = await postBookingToMake(bookingData);
        if(!mk.ok){
          setStatus(`âŒ Make webhook é€å‡ºå¤±æ•—\n${errToText(mk.error)}`, true);
          btnNext.disabled = false;
          return;
        }

        try{
          await sendFlexToChat();
          liff.closeWindow();
          return;
        }catch(e){
          setStatus(
            `âŒ æˆåŠŸå¯«å…¥é ç´„ï¼Œä½†å¡ç‰‡é€å‡ºå¤±æ•—\n` +
            `${errToText(e)}\n` +
            `æç¤ºï¼šè«‹ç¢ºèª LIFF çš„ Channel å·²å•Ÿç”¨ Messaging APIã€å·²é€£çµ OAï¼Œä¸” LIFF æœ‰ messaging scopeã€‚`,
            true
          );
          btnNext.disabled = false;
        }
      }
    };

    prevWeek.onclick=()=>goWeek(-1);
    nextWeek.onclick=()=>goWeek(1);

    setStep(1);
  }

  init();
</script>
</body>
</html>
