<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>支點運動_私課預約</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#111;
      --muted:#7a7a7a;
      --primary:#1bb57a;
      --border:rgba(0,0,0,.08);
      --shadow:0 8px 22px rgba(0,0,0,.07);
      --radius:18px;
      --chip:#f1f1f1;
      --chipSel:#dff4ea;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      font-size:18px;
    }
    .wrap{
      max-width:560px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .top{
      position:sticky; top:0;
      background:linear-gradient(180deg, rgba(246,247,248,1) 70%, rgba(246,247,248,.0));
      padding:14px 14px 10px;
      z-index:10;
    }
    .title{
      font-weight:950;
      font-size:20px;
      text-align:left;          /* ✅ 1) 標題靠左 */
      padding:4px 2px 12px;
    }
    .steps{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    .step{
      display:flex; align-items:center; gap:8px;
      flex:1;
      justify-content:center;
      min-width:0;
    }
    .dot{
      width:28px; height:28px;
      border-radius:999px;
      background:#e9f7f0;
      color:var(--primary);
      font-weight:950;
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      font-size:15px;
    }
    .dot.active{ background:var(--primary); color:#fff; }
    .label{
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:800;
    }
    .label.active{ color:var(--text); font-weight:950; }

    .card{
      background:var(--card);
      margin:12px 14px 0;
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .h{
      margin:0 0 10px;
      font-weight:950;
      font-size:22px;
    }

    .sub{
      margin:0 0 12px;
      color:var(--muted);
      font-size:16px;
      line-height:1.6;
    }
    #card1 .sub{ font-size:15px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }

    .chip{
      padding:12px 14px;
      border-radius:14px;
      background:var(--chip);
      font-weight:950;
      font-size:16px;
      cursor:pointer;
      user-select:none;
      border:1px solid transparent;
      min-width:120px;
      text-align:center;
    }
    .chip.sel{
      background:var(--chipSel);
      border-color:rgba(27,181,122,.35);
      outline:2px solid rgba(27,181,122,.35);
    }

    /* Step2 教練資訊卡 */
    .coachCard{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
      margin-bottom:12px;
    }
    .avatar{
      width:52px; height:52px;
      border-radius:999px;
      background:#ddd;
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .coachMeta{ flex:1; min-width:0; }
    .coachName{
      font-weight:950;
      font-size:18px;
      margin-bottom:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tags{ display:flex; flex-wrap:wrap; gap:6px; }
    .tag{
      font-size:12px;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      background:#f2f7f5;
      color:#1a7b57;
      border:1px solid rgba(27,181,122,.18);
    }

    /* 週曆 */
    .weekbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:6px 0 12px;
    }
    .navBtn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
      font-weight:950;
      font-size:18px;
    }
    .weekTitle{
      flex:1;
      text-align:center;
      font-weight:950;
      font-size:16px;
      color:#222;
    }
    .weekGrid{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:10px;
      align-items:stretch;
    }
    .dayCell{
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      padding:10px 6px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      box-shadow:0 6px 16px rgba(0,0,0,.04);
      position:relative;
      min-height:74px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }
    .wk{
      font-size:13px;
      color:#666;
      font-weight:950;
    }
    .md{
      font-size:16px;
      font-weight:950;
      color:#111;
    }
    .dayCell.sel{
      border-color:rgba(27,181,122,.35);
      outline:2px solid rgba(27,181,122,.35);
      background:var(--chipSel);
    }
    .dayCell.sel::before{
      content:"";
      position:absolute;
      left:50%; top:50%;
      width:58px; height:58px;
      transform:translate(-50%,-55%);
      border-radius:999px;
      background:rgba(27,181,122,.18);
      z-index:0;
    }
    .dayCell.sel .wk, .dayCell.sel .md{ position:relative; z-index:1; }

    /* Step3 tabs + slots */
    .tabs{
      display:flex;
      gap:10px;
      padding:6px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
      margin:10px 0 12px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding:10px 8px;
      border-radius:999px;
      font-weight:950;
      font-size:15px;
      color:#666;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:var(--primary);
      color:#fff;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    .slot{
      padding:14px 10px;
      border-radius:14px;
      background:var(--chip);
      font-weight:950;
      text-align:center;
      cursor:pointer;
      user-select:none;
      border:1px solid transparent;
      font-size:16px;
    }
    .slot.sel{
      background:var(--chipSel);
      border-color:rgba(27,181,122,.35);
      outline:2px solid rgba(27,181,122,.35);
    }
    .slot.disabled{
      opacity:.35;
      pointer-events:none;
    }

    .footer{
      margin-top:auto;
      position:sticky;
      bottom:0;
      padding:12px 14px 16px;
      background:linear-gradient(0deg, rgba(246,247,248,1) 60%, rgba(246,247,248,.0));
    }

    /* ✅ Step1 時只顯示一顆滿版按鈕 */
    .btnRow{
      display:flex;
      gap:10px;
    }
    .btn{
      border:0;
      border-radius:18px;
      padding:16px;
      font-size:18px;
      font-weight:950;
      cursor:pointer;
      box-shadow:var(--shadow);
      flex:1;
    }
    .btn.secondary{
      background:#fff;
      border:1px solid var(--border);
      color:#222;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    /* 控制 Step1 上一步不佔空間 */
    .hideBtn{ display:none !important; }

    /* 讓 Step1 的 Next 變滿版 */
    .fullWidth{ width:100%; }

    .status{
      margin-top:10px;
      font-size:14px;
      color:var(--muted);
      text-align:center;
    }
    .hide{ display:none; }

    /* Step1 沒教練時提示 */
    .emptyHint{
      color:#666;
      font-size:14px;
      line-height:1.6;
      padding:10px 0 0;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="title">支點運動_私課預約</div>
    <div class="steps">
      <div class="step">
        <div id="dot1" class="dot active">1</div>
        <div id="lab1" class="label active">選教練</div>
      </div>
      <div class="step">
        <div id="dot2" class="dot">2</div>
        <div id="lab2" class="label">選日期</div>
      </div>
      <div class="step">
        <div id="dot3" class="dot">3</div>
        <div id="lab3" class="label">選時段</div>
      </div>
    </div>
  </div>

  <!-- STEP 1 -->
  <div id="card1" class="card">
    <p class="h">Step 1｜選擇教練</p>
    <p class="sub">請先選擇教練，後續只會顯示可預約的日期與時段。</p>
    <div id="coachRow" class="row"></div>
    <div id="coachEmpty" class="emptyHint hide">目前沒有教練清單（COACHES 為空），請先填入教練資料。</div>
  </div>

  <!-- STEP 2 -->
  <div id="card2" class="card hide">
    <p class="h">Step 2｜選擇日期</p>

    <div id="coachInfo" class="coachCard">
      <div class="avatar">
        <img id="coachAvatar" alt="coach avatar" src="" />
      </div>
      <div class="coachMeta">
        <div id="coachName" class="coachName">—</div>
        <div id="coachTags" class="tags"></div>
      </div>
    </div>

    <div class="weekbar">
      <button id="prevWeek" class="navBtn" aria-label="prev">‹</button>
      <div id="weekTitle" class="weekTitle">—</div>
      <button id="nextWeek" class="navBtn" aria-label="next">›</button>
    </div>

    <div id="weekGrid" class="weekGrid"></div>
  </div>

  <!-- STEP 3 -->
  <div id="card3" class="card hide">
    <p class="h">Step 3｜選擇時段</p>

    <div class="tabs">
      <div id="tabAM" class="tab active">上午</div>
      <div id="tabPM" class="tab">下午</div>
      <div id="tabEV" class="tab">晚上</div>
    </div>

    <div id="slotGrid" class="grid"></div>

    <p class="sub" style="margin-top:12px;">⚠️ 預約/取消需在開課前 1 小時完成。</p>
  </div>

  <div class="footer">
    <div class="btnRow">
      <button id="btnPrev" class="btn secondary">上一步</button>
      <button id="btnNext" class="btn primary" disabled>下一步</button>
    </div>
    <div id="status" class="status">載入中…</div>
  </div>
</div>

<script>
  // ✅ 改成你的 LIFF ID
  const LIFF_ID = '2008631386-AEejMove';

  // ✅ Demo 教練（你可改成真名/大頭貼/標籤）
  const COACHES = [
    {
      id:'coachA',
      name:'偉銘',
      avatar:'https://i.imgur.com/8Km9tLL.png',
      tags:['肌力訓練','姿勢調整','初學友善']
    },
    {
      id:'coachB',
      name:'教練 B',
      avatar:'https://i.imgur.com/4ZQZ4ZB.png',
      tags:['體能訓練','減脂','銀髮友善']
    },
  ];

  const ROOM = { id:'room1', name:'場地' };

  const state = {
    step: 1,
    uid: '',
    name: '',
    coach: null,
    weekStart: null,
    dateKey: null,
    tab: 'AM',
    slot: null
  };

  const $ = s => document.querySelector(s);

  const dot1=$('#dot1'), dot2=$('#dot2'), dot3=$('#dot3');
  const lab1=$('#lab1'), lab2=$('#lab2'), lab3=$('#lab3');
  const card1=$('#card1'), card2=$('#card2'), card3=$('#card3');

  const coachRow=$('#coachRow');
  const coachEmpty=$('#coachEmpty');

  const coachAvatar=$('#coachAvatar'), coachName=$('#coachName'), coachTags=$('#coachTags');
  const weekTitle=$('#weekTitle'), weekGrid=$('#weekGrid');
  const prevWeek=$('#prevWeek'), nextWeek=$('#nextWeek');

  const tabAM=$('#tabAM'), tabPM=$('#tabPM'), tabEV=$('#tabEV');
  const slotGrid=$('#slotGrid');

  const btnPrev=$('#btnPrev'), btnNext=$('#btnNext'), status=$('#status');

  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmtYMD(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function parseYMD(ymd){ const [y,m,dd]=ymd.split('-').map(Number); return new Date(y, m-1, dd); }
  function wkChar(d){ return '日一二三四五六'[d.getDay()]; }

  function startOfWeekMonday(date){
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }
  function addDays(date, n){
    const d=new Date(date);
    d.setDate(d.getDate()+n);
    return d;
  }

  /* ✅ Step1 上一步不顯示、不佔空間；Next 變滿版 */
  function applyFooterLayout(){
    if(state.step===1){
      btnPrev.classList.add('hideBtn');   // ✅ 完全消失
      btnNext.classList.add('fullWidth'); // ✅ 下一步滿版
    }else{
      btnPrev.classList.remove('hideBtn');
      btnNext.classList.remove('fullWidth');
    }
  }

  function setStep(n){
    state.step = n;

    [dot1,dot2,dot3].forEach((d,i)=>d.classList.toggle('active', i+1===n));
    [lab1,lab2,lab3].forEach((l,i)=>l.classList.toggle('active', i+1===n));

    card1.classList.toggle('hide', n!==1);
    card2.classList.toggle('hide', n!==2);
    card3.classList.toggle('hide', n!==3);

    if(n===1) btnNext.textContent='下一步';
    if(n===2) btnNext.textContent='下一步';
    if(n===3) btnNext.textContent='確認預約';

    if(n===1) btnNext.disabled = !state.coach;
    if(n===2) btnNext.disabled = !state.dateKey;
    if(n===3) btnNext.disabled = !state.slot;

    // ✅ 底部文字：每一步都正確顯示
    if(n===1) status.textContent = `${state.name || '用戶'} 您好，第一步請先選擇教練`;
    if(n===2) status.textContent = `第二步請選擇日期（已選：${state.coach?.name || '教練'}）`;
    if(n===3) status.textContent = `第三步請選擇時段（上午/下午/晚上）`;

    applyFooterLayout();
  }

  /* ---------- Step 1: Coaches ---------- */
  function renderCoaches(){
    coachRow.innerHTML='';

    if(!Array.isArray(COACHES) || COACHES.length===0){
      coachEmpty.classList.remove('hide');
      return;
    }else{
      coachEmpty.classList.add('hide');
    }

    COACHES.forEach(c=>{
      const div=document.createElement('div');
      div.className='chip'+(state.coach?.id===c.id?' sel':'');
      div.textContent=c.name;
      div.onclick=()=>{
        state.coach=c;
        renderCoaches();
        btnNext.disabled=false;
      };
      coachRow.appendChild(div);
    });
  }

  function renderCoachInfo(){
    if(!state.coach){
      coachAvatar.src='';
      coachName.textContent='—';
      coachTags.innerHTML='';
      return;
    }
    coachAvatar.src = state.coach.avatar || '';
    coachName.textContent = state.coach.name;

    coachTags.innerHTML='';
    (state.coach.tags || []).slice(0,6).forEach(t=>{
      const span=document.createElement('span');
      span.className='tag';
      span.textContent=t;
      coachTags.appendChild(span);
    });
  }

  /* ---------- Step 2: Week calendar ---------- */
  function renderWeekTitle(){
    const s = state.weekStart;
    const e = addDays(s, 6);
    weekTitle.textContent = `${s.getFullYear()}/${pad2(s.getMonth()+1)}/${pad2(s.getDate())} － ${e.getFullYear()}/${pad2(e.getMonth()+1)}/${pad2(e.getDate())}`;
  }

  function withinBookingWindow(dateObj){
    const end = new Date();
    end.setDate(end.getDate() + 7);
    end.setHours(23,59,59,999);
    return dateObj <= end;
  }

  function renderWeekGrid(){
    weekGrid.innerHTML='';
    renderWeekTitle();

    for(let i=0;i<7;i++){
      const d = addDays(state.weekStart, i);
      const ymd = fmtYMD(d);

      const cell = document.createElement('div');
      cell.className = 'dayCell' + (state.dateKey===ymd ? ' sel' : '');

      const w = document.createElement('div');
      w.className='wk';
      w.textContent = wkChar(d);

      const md = document.createElement('div');
      md.className='md';
      md.textContent = `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;

      cell.appendChild(w);
      cell.appendChild(md);

      const inRange = withinBookingWindow(d);
      if(!inRange){
        cell.style.opacity = '.35';
        cell.style.pointerEvents = 'none';
      }

      cell.onclick=()=>{
        state.dateKey = ymd;
        state.slot = null;
        renderWeekGrid();
        renderSlots();
        btnNext.disabled = false;
      };

      weekGrid.appendChild(cell);
    }
  }

  prevWeek.onclick=()=>{
    state.weekStart = addDays(state.weekStart, -7);
    renderWeekGrid();
  };
  nextWeek.onclick=()=>{
    state.weekStart = addDays(state.weekStart, 7);
    renderWeekGrid();
  };

  /* ---------- Step 3: Tabs + Slots ---------- */
  function setTab(t){
    state.tab = t;
    tabAM.classList.toggle('active', t==='AM');
    tabPM.classList.toggle('active', t==='PM');
    tabEV.classList.toggle('active', t==='EV');
    state.slot = null;
    renderSlots();
    btnNext.disabled = true;
  }
  tabAM.onclick=()=>setTab('AM');
  tabPM.onclick=()=>setTab('PM');
  tabEV.onclick=()=>setTab('EV');

  function slotsByTab(tab){
    if(tab==='AM') return ['10:00','11:00','12:00'];
    if(tab==='PM') return ['13:00','14:00','15:00','16:00','17:00'];
    return ['18:00','19:00','20:00','21:00'];
  }

  function genSlotsForSelectedDate(){
    const ymd = state.dateKey;
    if(!ymd) return [];
    const base = parseYMD(ymd);
    const nowPlus1h = new Date(Date.now() + 60*60*1000);

    return slotsByTab(state.tab).map(t=>{
      const [hh,mm] = t.split(':').map(Number);
      const dt = new Date(base.getFullYear(), base.getMonth(), base.getDate(), hh, mm, 0);
      const disabled = dt < nowPlus1h;
      return { t, disabled };
    });
  }

  function renderSlots(){
    slotGrid.innerHTML='';
    if(!state.dateKey){
      slotGrid.innerHTML='<div style="grid-column:1/-1;color:#777;">請先選日期</div>';
      return;
    }
    const slots = genSlotsForSelectedDate();
    if(slots.length===0){
      slotGrid.innerHTML='<div style="grid-column:1/-1;color:#777;">此日無可預約時段</div>';
      return;
    }

    slots.forEach(s=>{
      const div=document.createElement('div');
      div.className='slot' + (s.disabled?' disabled':'') + (state.slot===s.t?' sel':'');
      div.textContent=s.t;
      div.onclick=()=>{
        state.slot=s.t;
        renderSlots();
        btnNext.disabled=false;
      };
      slotGrid.appendChild(div);
    });
  }

  /* ---------- Buttons ---------- */
  btnPrev.onclick=()=>{
    if(state.step===2){ setStep(1); return; }
    if(state.step===3){ setStep(2); return; }
  };

  btnNext.onclick=async ()=>{
    if(state.step===1){
      if(!state.coach) return;
      renderCoachInfo();
      renderWeekGrid();
      setStep(2);
      return;
    }

    if(state.step===2){
      if(!state.dateKey) return;
      setTab('AM');
      renderSlots();
      setStep(3);
      return;
    }

    if(!state.slot) return;

    const text =
      `#BOOK coach=${state.coach.id} room=${ROOM.id} date=${state.dateKey} time=${state.slot} dur=60`;

    btnNext.disabled=true;
    status.textContent='送出中…';

    try{
      await liff.sendMessages([{ type:'text', text }]);
      status.textContent='✅ 已送出，回到聊天室處理預約…';
      setTimeout(()=>liff.closeWindow(), 600);
    }catch(e){
      status.textContent='❌ 送出失敗，請確認是在 LINE 內開啟此頁面';
      btnNext.disabled=false;
    }
  };

  async function init(){
    try{
      status.textContent='載入中…';

      await liff.init({ liffId: LIFF_ID });

      if(!liff.isLoggedIn()){
        // 在 LINE 外開啟會走 login，避免卡住
        liff.login();
        return;
      }

      const profile=await liff.getProfile();
      state.uid=profile.userId;
      state.name=profile.displayName || '';

      state.weekStart = startOfWeekMonday(new Date());

      renderCoaches();
      setStep(1);

    }catch(err){
      console.error(err);
      status.textContent = '❌ 初始化失敗：請確認用 LINE 內開啟，或 LIFF ID 是否正確';
      // 就算失敗，也讓頁面可操作（至少看到教練列表）
      renderCoaches();
      setStep(1);
    }
  }

  init();
</script>
</body>
</html>
