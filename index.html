<script>
  const LIFF_ID = '2008631386-AEejMove';

  const COACHES = [
    { id:'coachA', name:'教練 A' },
    { id:'coachB', name:'教練 B' },
  ];

  const ROOM = { id:'room1', name:'場地' };

  const state = {
    step: 1,
    uid: '',
    name: '',
    coach: null,
    dateKey: null,
    slot: null
  };

  const $ = s => document.querySelector(s);

  const dot1=$('#dot1'), dot2=$('#dot2'), dot3=$('#dot3');
  const lab1=$('#lab1'), lab2=$('#lab2'), lab3=$('#lab3');
  const card1=$('#card1'), card2=$('#card2'), card3=$('#card3');
  const coachRow=$('#coachRow'), dateRow=$('#dateRow'), slotGrid=$('#slotGrid');
  const btn=$('#btn'), status=$('#status');

  function updateStatus(){
    const who = state.name ? `${state.name} 您好，` : '';
    if(state.step === 1){
      status.textContent = `${who}私課預約第一步請先選擇教練`;
    }else if(state.step === 2){
      status.textContent = `${who}第二步請選擇日期`;
    }else{
      status.textContent = `${who}最後一步請選擇時段並按下「確認預約」`;
    }
  }

  function setStep(n){
    state.step = n;

    [dot1,dot2,dot3].forEach((d,i)=>d.classList.toggle('active', i+1===n));
    [lab1,lab2,lab3].forEach((l,i)=>l.classList.toggle('active', i+1===n));

    card1.classList.toggle('hide', n!==1);
    card2.classList.toggle('hide', n!==2);
    card3.classList.toggle('hide', n!==3);

    if(n===1){
      btn.textContent='下一步';
      btn.disabled = !state.coach;
    }else if(n===2){
      btn.textContent='下一步';
      btn.disabled = !state.dateKey;
    }else{
      btn.textContent='確認預約';
      btn.disabled = !state.slot;
    }

    updateStatus();
  }

  function fmtYMD(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function fmtLabel(ymd){
    const [y,m,d]=ymd.split('-').map(Number);
    const dt=new Date(y,m-1,d);
    const wk='日一二三四五六'[dt.getDay()];
    return `${y}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}（${wk}）`;
  }

  function renderCoaches(){
    coachRow.innerHTML='';
    COACHES.forEach(c=>{
      const div=document.createElement('div');
      div.className='chip'+(state.coach?.id===c.id?' sel':'');
      div.textContent=c.name;
      div.onclick=()=>{
        state.coach=c;
        renderCoaches();
        btn.disabled=false;
      };
      coachRow.appendChild(div);
    });
  }

  function renderDates(){
    dateRow.innerHTML='';
    const now=new Date();
    for(let i=0;i<7;i++){
      const d=new Date(now);
      d.setDate(now.getDate()+i);
      const ymd=fmtYMD(d);
      const div=document.createElement('div');
      div.className='chip'+(state.dateKey===ymd?' sel':'');
      div.textContent=fmtLabel(ymd);
      div.onclick=()=>{
        state.dateKey=ymd;
        state.slot=null;
        renderDates();
        renderSlots();
        btn.disabled=false;
      };
      dateRow.appendChild(div);
    }
  }

  function genSlotsForDate(ymd){
    const out=[];
    for(let h=10; h<=21; h++){
      out.push(String(h).padStart(2,'0')+':00');
    }

    const nowPlus1h=new Date(Date.now()+60*60*1000);
    const [y,m,d]=ymd.split('-').map(Number);

    return out.map(t=>{
      const [hh,mm]=t.split(':').map(Number);
      const dt=new Date(y,m-1,d,hh,mm,0);
      return { t, disabled: dt < nowPlus1h };
    });
  }

  function renderSlots(){
    slotGrid.innerHTML='';
    if(!state.dateKey){
      slotGrid.innerHTML='<div style="grid-column:1/-1;color:#777;">請先選日期</div>';
      return;
    }
    const slots=genSlotsForDate(state.dateKey);
    slots.forEach(s=>{
      const div=document.createElement('div');
      div.className='slot'+(s.disabled?' disabled':'')+(state.slot===s.t?' sel':'');
      div.textContent=s.t;
      div.onclick=()=>{
        state.slot=s.t;
        renderSlots();
        btn.disabled=false;
      };
      slotGrid.appendChild(div);
    });
  }

  async function init(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) liff.login();

    const profile=await liff.getProfile();
    state.uid=profile.userId;
    state.name=profile.displayName || '';

    renderCoaches();
    renderDates();
    renderSlots();

    setStep(1); // 這行會順便 updateStatus()
    updateStatus();

    btn.onclick=async ()=>{
      if(state.step===1){
        setStep(2);
        return;
      }
      if(state.step===2){
        setStep(3);
        return;
      }

      const text =
        `#BOOK coach=${state.coach.id} room=${ROOM.id} date=${state.dateKey} time=${state.slot} dur=60`;

      btn.disabled=true;
      status.textContent='送出中…';

      try{
        await liff.sendMessages([{ type:'text', text }]);
        status.textContent='✅ 已送出，回到聊天室處理預約…';
        setTimeout(()=>liff.closeWindow(), 600);
      }catch(e){
        status.textContent='❌ 送出失敗，請重試（請確認在 LINE App 內開啟）';
        btn.disabled=false;
      }
    };
  }

  init();
</script>
